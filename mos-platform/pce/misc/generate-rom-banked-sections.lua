-- Copyright (c) 2023 Adrian "asie" Siekierka
--
-- Licensed under the Apache License, Version 2.0 with LLVM Exceptions,                                   
-- See https://github.com/llvm-mos/llvm-mos-sdk/blob/main/LICENSE for license                             
-- information.

local ALLOW_MOVING_ROM_VBANK_0 = false
local VBANK_MAX = 128
local BANK_KB = 8

function printf(...)
	print(string.format(table.unpack({...})))
end

print("/* Automatically generated by generate-rom-banked-sections.lua. */\n")

-- for each bank, define "offset", "size"
-- bank 0 - fixed 8KB bank at $E000
if ALLOW_MOVING_ROM_VBANK_0 then
	printf("PROVIDE(__rom_vbank_0 = 0xe000);")
	printf("PROVIDE(__rom_vbank_0_size = 0x2000);")
else
	printf("__rom_vbank_0 = 0xe000;")
	printf("__rom_vbank_0_size = 0x2000;")
end
printf("__rom_vbank_0_offset = 0;")
-- banks 1+ - empty bank placeholders
for i = 1,VBANK_MAX-1 do
	printf("PROVIDE(__rom_vbank_%d = 0x4000);", i)
	printf("PROVIDE(__rom_vbank_%d_size = 0);", i)
	printf("__rom_vbank_%d_offset = __rom_vbank_%d_offset + __rom_vbank_%d_size;", i, i-1, i-1)
end
for i = 0,VBANK_MAX-1 do
	printf("__rom_vbank_%d_bank = __rom_vbank_%d_offset >> 13;", i, i)
	printf("__rom_vbank_%d_lma = (__rom_vbank_%d_bank << 16) + __rom_vbank_%d;", i, i, i)
end

printf("__rom_vbank_end_offset = __rom_vbank_%d_offset + __rom_vbank_%d_size;", VBANK_MAX-1, VBANK_MAX-1);
printf("ASSERT(__rom_vbank_end_offset <= %d, \"ROM size cannot be larger than %d KB.\");", VBANK_MAX*BANK_KB*1024, VBANK_MAX*BANK_KB)

-- define memory sections
printf("")
printf("MEMORY {")
for i = 0,VBANK_MAX-1 do
	printf("  rom_vbank_%d : ORIGIN = __rom_vbank_%d_lma, LENGTH = __rom_vbank_%d_size", i, i, i)
end
printf("}")

printf("")
printf("SECTIONS {")
for i = 0,VBANK_MAX-1 do
	printf("  .rom_vbank_%d : { *(.rom_vbank_%d .rom_vbank_%d.*) } >rom_vbank_%d", i, i, i, i)
end
printf("}")

printf("")
printf("OUTPUT_FORMAT {")
for i = 0,VBANK_MAX-1 do
	printf("  FULL(rom_vbank_%d)", i)
end
printf("}")
